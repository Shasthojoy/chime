{% extends "base.html" %}

{% set breadcrumb_items = [{'name': 'Activities', 'url': '/'}] %}

{% block title %}Activity Overview{% endblock %}


{% set template_name = 'activity-overview' %}
{% block body_class %}{{template_name}}{% endblock %}

{% block scripts %}

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="/static/javascript/activity-summary.js"></script>

{% endblock%}

{% block content %}
<!-- template name: {{template_name}} -->
<div class="activity-overview__container col__flex">
    <div class="activity-overview__main">
        <div class="activity-overview__header">
            <p class="activity-overview__subtitle">Activity Overview</p>
            <h1 class="activity-overview__title">{{ activity.task_description | title }} For {{ activity.task_beneficiary | title }}</h1>
            <p class="activity-overview__details">Last edited by {{ activity.last_edited_email }}.</p>
        </div>

        <ul class="activity-progress">
            {% set review_step = 0 %}
            {% if activity.review_state == "unreviewed edits" %}
                {% set review_step = 1 %}
            {% elif activity.review_state == "feedback requested" %}
                {% set review_step = 2 %}
            {% elif activity.review_state == "edits endorsed" %}
                {% set review_step = 3 %}
            {% elif activity.review_state == "changes published" %}
                {% set review_step = 4 %}
            {% endif %}

            <li class="activity-progress__item {% if review_step > 0 %}completed{% endif %}">
                <div class="activity-progress__icon fa fa-pencil"></div>
                <p class="activity-progress__label">Edits Made</p>
            </li>
            <li class="activity-progress__item {% if review_step > 1 %}completed{% endif %}">
                <div class="activity-progress__icon fa fa-eye"></div>
                <p class="activity-progress__label">Feedback Requested</p>
            </li>
            <li class="activity-progress__item {% if review_step > 2 %}completed{% endif %}">
                <div class="activity-progress__icon fa fa-thumbs-o-up"></div>
                <p class="activity-progress__label">Edits Endorsed</p>
            </li>
            <li class="activity-progress__item {% if review_step > 3 %}completed{% endif %}">
                <div class="activity-progress__icon fa fa-check"></div>
                <p class="activity-progress__label">Published</p>
            </li>
        </ul>

        <div class="activity-summary">
            <a href="#" class="activity-summary__toggle">3 articles and categories have been changed (click to review)</a>
            <table class="activity-summary__table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Changes</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="activity-summary__name">Snowstorm Operations</td>
                        <td class="activity-summary__filetype">Article</td>
                        <td class="activity-summary__changes">Created, Edited</td>
                    </tr>
                    <tr>
                        <td class="activity-summary__name">Public Safety</td>
                        <td class="activity-summary__filetype">Category</td>
                        <td class="activity-summary__changes">Description Edited</td>
                    </tr>
                    <tr>
                        <td class="activity-summary__name">Snowstorm Operations</td>
                        <td class="activity-summary__filetype">Article</td>
                        <td class="activity-summary__changes">Created, Edited</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="activity-log">

            {% set comment_note = "leave a comment" %}

            {% if activity.review_authorized %}
                {% if activity.review_state == 'unreviewed edits' %}
                    {% set comment_note = "request feedback on your work" %}
                {% elif activity.review_state == 'feedback requested' %}
                    {% set comment_note = "leave feedback on" + activity.last_edited_email + "'s changes" %}
                {% elif activity.review_state == 'edits endorsed' %}
                    {% set comment_note = "publish changes to the site" %}
                {% endif %}
            {% else %}
                {% if activity.review_state == 'feedback requested' %}
                    {% set comment_note = "leave a comment. Currently awaiting someone to look over your work" %}
                {% endif %}
            {% endif %}

            <p class="activity-overview__description"><a href="{{ activity.edit_path }}">Do more work on this activity</a> or {{ comment_note }}.</p>

            {% if activity.review_state != 'changes published' %}
            <div class="activity-log-item activity-log-item--comment">
                <form action="." method="POST" class="comment comment--new">
                    <div class="comment__author">{% if email %}{{ email }}{% else %}unknown{% endif %}</div>
                    <div class="comment__body">
                        <textarea class="comment__input" name="comment_text" placeholder="Leave your comment here"></textarea>
                    </div>
                    <div class="comment__actions toolbar toolbar--right">
                    {% if activity.review_authorized %}
                        {% if activity.review_state == 'unreviewed edits' %}
                        <input class="toolbar__item button button--orange" type="submit" name="request_feedback" value="Request Feedback">
                        {% elif activity.review_state == 'feedback requested' %}
                        <input class="toolbar__item button button--green" type="submit" name="endorse_edits" value="Looks Good!">
                        {% elif activity.review_state == 'edits endorsed' %}
                        <input class="toolbar__item button button--blue" type="submit" name="merge" value="Publish">
                        {% endif %}
                    {% endif %}
                        <input class="toolbar__item button button" type="submit" name="comment" value="Leave a Comment">
                    </div>
                </form>
            </div>
            {% endif %}

            {% for log_item in activity.history %}
            <div class="activity-log-item activity-log-item--{{ log_item.commit_category }}">
                {% if log_item.commit_type == 'comment' %}
                <div class="comment">
                    <div class="comment__author">{{ log_item.author_email }}</div>
                    <div class="comment__body">{{ log_item.commit_body }}</div>
                    <div class="comment__datetime">{{ log_item.commit_date }}</div>
                </div>
                {% elif log_item.commit_type == 'review update' %}
                <div class="activity-log-item__content">
                    <p class="text-{% if log_item.commit_action == 'feedback requested' %}orange{% elif log_item.commit_action == 'edits endorsed' %}green{% else %}blue{% endif %}">{{ log_item.author_email }} {{ log_item.commit_body }}</p>
                    <div class="activity-log-item__datetime">{{ log_item.commit_date }}</div>
                </div>
                {% else %}
                <div class="activity-log-item__content">
                    <p>{{ log_item.commit_subject }} by {{ log_item.author_email }}.</p>
                    <div class="activity-log-item__datetime">{{ log_item.commit_date }}</div>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
</div>

{% endblock %}

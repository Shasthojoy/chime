{% extends "base_new.html" %}

{% set template_name = 'articles-list' %}
{% block body_class %}{{template_name}}{% endblock %}

{% set breadcrumb_items = [{'name': 'Activites', 'url': '/'}] %}

{% block title %}Browse{% endblock %}

{% block content %}

<!-- task: {% if task_description %}{{task_description}}{% elif task %}{{task}}{% else %}{{name}}{% endif %} -->
<!-- beneficiary: {% if task_beneficiary %}{{task_beneficiary}}{% endif %} -->
<!-- template name: {{template_name}} -->
{% set icon_class_lookup = {'folder': 'fa fa-folder-o', 'file': 'fa fa-file-text-o', 'category': 'fa fa-folder', 'article': 'fa fa-file-text'} %}
<div class="articles-list__main grid col__flex">
    {% for column in dir_columns %}
    {% if loop.index != 1 or (loop.index == 1 and dir_columns|length == 1) %}
    <div class="dir grid__item {% if loop.index == 4 %}width-one-half{% else %}width-one-fourth{% endif %}">
      {% if loop.index == 2 %}
      <h2>Categories</h2>
      <div class="selection-box box-add-file-folder">
        <form action="." method="POST" class="form-one-line">
            <input class="form-one-line__input" name="path" placeholder="Add Category" type="text" />
            <input name="create_what" value="category" type="hidden" />
            <input name="create_path" value="{{column['path']}}" type="hidden" />
            <input class="form-one-line__submit button" name="action" type="submit" value="Create" />
        </form>
      </div>
      {% elif loop.index == 3 %}
      <h2>Subcategories</h2>
      <div class="selection-box box-add-file-folder">
        <form action="." method="POST" class="form-one-line">
            <input class="form-one-line__input" name="path" placeholder="Add Subcategory" type="text" />
            <input name="create_what" value="category" type="hidden" />
            <input name="create_path" value="{{column['path']}}" type="hidden" />
            <input class="form-one-line__submit button" name="action" type="submit" value="Create" />
        </form>
      </div>
      {% elif loop.index == 4 %}
      <h2>Articles</h2>
      <div class="selection-box box-add-file-folder">
        <form action="." method="POST" class="form-one-line">
            <input class="form-one-line__input" name="path" placeholder="Add Article" type="text" />
            <input name="create_what" value="article" type="hidden" />
            <input name="create_path" value="{{column['path']}}" type="hidden" />
            <input class="form-one-line__submit button" name="action" type="submit" value="Create" />
        </form>
      </div>
      {% endif %}
      <ul class="dir">
        {% for file in column['files'] %}
         <!-- file type: {{file['display_type']}}, file name: {{file['name']}} -->
         <li class="dir-item row {% if file['selected'] == True %}is-selected{% endif %}">
            <a class="dir-item__name {{file['display_type']}} row__left" href="{{file['edit_path']}}"><span class="{{icon_class_lookup[file['display_type']]}}"></span>{{ file['name']  | title | replace('-', ' ') }}</a>
            <div class="dir-item__actions toolbar--right row__right">
              <a href="#"><span class="fa fa-pencil"></span></a>
            </div>
          </li>
        {% endfor %}   
      </ul>
    </div>
    {% endif %}
    {% endfor %}
</div>

<div class="row taskbar">
  <div class="taskbar__info row__left">
    <p class="taskbar__task"><b>{% if task_description %}{{task_description}}{% else %}{{branch}}{% endif %}{% if task_beneficiary %} for {{task_beneficiary}}{% endif %}</p>
  </div>
  <div class="taskbar__actions row__right toolbar--right">
        <!-- testing to get some buttons... this next line should be  if needs_peer_review and not eligible_peer -->
        {{ eligible_peer }}
        {% if needs_peer_review and not eligible_peer %}
        <form action="/merge" method="POST" class="toolbar__item">
          <input name="branch" value="{{branch}}" type="hidden" />
          <a href="mailto:?to=&amp;subject={{review_subject|urlencode}}&amp;body={{review_body|urlencode}}" class="button button--white">Submit for review</a>
        </form>    

        {% elif is_peer_approved and eligible_peer %}
        <form action="/merge" method="POST" class="toolbar__item">
          <input name="branch" value="{{branch}}" type="hidden" />
          <a class="toolbar__item button button--white text-red" href="/tree/{{safe_branch}}/review">Request Fixes</a>
          <button name="action" value="merge" type="submit" class="button button--white">Publish</button>
        </form>    

        {% elif is_peer_rejected and eligible_peer %}

        <div class="toolbar__item taskbar__feedback dropdown">
            See Feedback
            <div class="dropdown__popup dropdown__popup--right">
              <p>{{rejection_message}}<br>— {{rejecting_peer}}</p>
            </div>
        </div>

        <form action="/merge" method="POST" class="toolbar__item">
          <input name="branch" value="{{branch}}" type="hidden" />
          <a href="mailto:?to=&amp;subject={{review_subject|urlencode}}&amp;body={{review_body|urlencode}}" class="button button--white">Resubmit for review</a>
        </form>    
        

    {% elif needs_peer_review and eligible_peer %}
    <!-- Reviewer options -->
    <form action="/review" method="POST" class="toolbar--right">
      <input name="branch" value="{{branch}}" type="hidden" />
      <a class="toolbar__item button button--white text-red" href="/tree/{{safe_branch}}/review">Request Fixes</a>
      <button name="action" value="approve" type="submit" class="toolbar__item button button--white text-green">Approve</button>
    </form>    
    {% else %}


    {% endif %}

    {% if rejection_messages %}

    <h5>All feedback</h5>
    <ul>
      {% for (email, message) in rejection_messages %}
      <li>{{message}}<br>— {{email}}</li>
      {% endfor %}
    </ul>

    {% endif %}
  </div>
</div>


{% endblock %}

